<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - DSS</title>
    <link rel="stylesheet" th:href="@{/css/neo-dashboard.css}" />
  </head>
  <body>
    <nav class="navbar">
      <div class="navbar-brand">üéØ DSS - Admin Portal</div>
      <div class="navbar-user">
        <div class="user-info">
          <div class="user-name" th:text="${user.fullName}">Admin User</div>
          <div class="user-role" th:text="${user.role.displayName}">
            Admin/Director
          </div>
        </div>
        <form th:action="@{/logout}" method="post" class="logout-form">
          <button type="submit" class="btn-logout">Logout</button>
        </form>
      </div>
    </nav>

    <div class="container">
      <div class="welcome-section">
        <h1>Welcome back, <span th:text="${user.fullName}">Admin</span>! üëã</h1>
        <p>Monthly & Country Sales Overview for Top SKUs - Descriptive DSS</p>
      </div>

      <!-- Filter Section -->
      <div class="filter-section">
        <h2>üìä Filter Configuration</h2>
        <div class="filter-grid">
          <div class="filter-item">
            <label for="startDate">üìÖ Start Date</label>
            <input type="date" id="startDate" class="filter-input" />
            <small>Leave empty to use all data</small>
          </div>

          <div class="filter-item">
            <label for="endDate">üìÖ End Date</label>
            <input type="date" id="endDate" class="filter-input" />
            <small>Leave empty to use all data</small>
          </div>

          <div class="filter-item">
            <label for="countryFilter">üåç Country Filter</label>
            <select id="countryFilter" class="filter-input" multiple size="5">
              <option value="" selected>All Countries</option>
            </select>
            <small>Hold Ctrl/Cmd to select multiple</small>
          </div>

          <div class="filter-item">
            <label for="topN">üèÜ Top-N Items</label>
            <input
              type="range"
              id="topN"
              class="filter-slider"
              min="5"
              max="50"
              value="10"
              step="5"
            />
            <output id="topNValue">10</output>
            <small>Number of top items to display (5-50)</small>
          </div>

          <div class="filter-item">
            <label
              for="excludeCancelled"
              class="filter-toggle"
            >
              <input
                type="checkbox"
                id="excludeCancelled"
                checked
                class="filter-checkbox"
              />
              üö´ Exclude Cancellations
            </label>
            <small>Remove invoices starting with 'C'</small>
          </div>

          <div class="filter-item filter-item--actions">
            <button id="applyFilters" class="btn-apply">Apply Filters</button>
          </div>
        </div>
      </div>

      <div class="dashboard-grid">
        <div class="stat-card">
          <div class="stat-card-icon">üìä</div>
          <div class="stat-card-title">Total Revenue</div>
          <div class="stat-card-value" id="totalRevenue">Loading...</div>
        </div>

        <div class="stat-card">
          <div class="stat-card-icon">üì¶</div>
          <div class="stat-card-title">Total Transactions</div>
          <div class="stat-card-value" id="totalTransactions">Loading...</div>
        </div>

        <div class="stat-card">
          <div class="stat-card-icon">üåç</div>
          <div class="stat-card-title">Active Countries</div>
          <div class="stat-card-value" id="activeCountries">Loading...</div>
        </div>

        <div class="stat-card">
          <div class="stat-card-icon">üìà</div>
          <div class="stat-card-title">Top-10 Share</div>
          <div class="stat-card-value" id="topNShare">Loading...</div>
        </div>
      </div>

      <!-- Monthly Trend Chart -->
      <div class="chart-container">
        <h2>üìà Monthly Revenue Trend</h2>
        <div id="monthlyTrendContainer">
          <canvas id="monthlyTrendChart"></canvas>
        </div>
      </div>

      <!-- Top Countries Chart -->
      <div class="chart-container">
        <h2>üåç Top Countries by Revenue (Bar Chart)</h2>
        <div class="chart-area">
          <canvas id="topCountriesChart" ></canvas>
        </div>
        <small class="muted-note"
          >üí° Click on a bar to filter dashboard by that country</small
        >
      </div>

      <!-- Top Countries Table -->
      <div class="chart-container">
        <h2>üìä Country Ranking Details</h2>
        <div id="topCountriesContainer">
          <table id="topCountriesTable">
            <thead>
              <tr>
                <th>Rank</th>
                <th>Country</th>
                <th>Revenue</th>
                <th>Share %</th>
                <th>Transactions</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="5" class="loading">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="table-actions">
          <button
            class="btn-export"
            onclick="exportTable('topCountriesTable', 'Top_Countries')"
          >
            üì• Export to CSV
          </button>
        </div>
      </div>

      <!-- Top Products Chart -->
      <div class="chart-container">
        <h2>üèÜ Top Products by Revenue (Bar Chart)</h2>
        <div class="chart-area">
          <canvas id="topProductsChart" ></canvas>
        </div>
        <small class="muted-note"
          >üí° Click on a bar to view product trend over time</small
        >
      </div>

      <!-- Top Products Table -->
      <div class="chart-container">
        <h2>üìä SKU Ranking Details</h2>
        <div id="topProductsContainer">
          <table id="topProductsTable">
            <thead>
              <tr>
                <th>Rank</th>
                <th>Product</th>
                <th>Revenue</th>
                <th>Share %</th>
                <th>Transactions</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="5" class="loading">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="table-actions">
          <button
            class="btn-export"
            onclick="exportTable('topProductsTable', 'Top_Products')"
          >
            üì• Export to CSV
          </button>
        </div>
      </div>

      <!-- Action Recommendations -->
      <div class="insights-section">
        <h2>üí° Analysis & Recommendations</h2>
        <div id="recommendationsContainer">
          <table id="recommendationsTable">
            <thead>
              <tr>
                <th>Category</th>
                <th>Item</th>
                <th>Reason</th>
                <th>Recommended Action</th>
                <th>Priority</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="5" class="loading">Analyzing data...</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="insights-actions">
          <button class="btn-save-insights" onclick="saveInsights()">
            üíæ Save Insights
          </button>
          <button
            class="btn-export"
            onclick="exportTable('recommendationsTable', 'Action_Recommendations')"
          >
            üì• Export Recommendations
          </button>
        </div>
      </div>

      <div class="quick-actions">
        <h2>Quick Actions</h2>
        <div class="action-grid">
          <a href="/invoices" class="action-btn">
            <span class="action-btn-icon">üìã</span>
            View Invoices
          </a>
          <a href="/admin/orders" class="action-btn">
            <span class="action-btn-icon">üõí</span>
            Manage Orders
          </a>
          <a href="/admin/customers" class="action-btn">
            <span class="action-btn-icon">ÔøΩ</span>
            Manage Customers
          </a>
          <a href="/admin/users" class="action-btn">
            <span class="action-btn-icon">ÔøΩ</span>
            Manage Users
          </a>
          <a href="/admin/products" class="action-btn">
            <span class="action-btn-icon">üì¶</span>
            Manage Products
          </a>
        </div>
      </div>
    </div>

    <!-- SKU Trend Modal -->
    <div id="skuTrendModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalProductTitle">Product Trend</h2>
          <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div id="modalChartContainer">
          <canvas id="modalTrendChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <script>
      // API Configuration
      const ADMIN_API_URL = "http://localhost:8001";

      // Global state
      let currentFilters = {
        start_date: null,
        end_date: null,
        countries: [],
        top_n: 10,
        exclude_cancelled: true,
      };

      let currentData = {
        kpis: null,
        monthlyTrend: null,
        topCountries: null,
        topProducts: null,
      };

      // Initialize page
      window.addEventListener("DOMContentLoaded", function () {
        initializeFilters();
        loadCountryOptions();
        loadAllData();
      });

      // Initialize filter controls
      function initializeFilters() {
        // Top-N slider
        const slider = document.getElementById("topN");
        const output = document.getElementById("topNValue");
        slider.oninput = function () {
          output.value = this.value;
        };

        // Apply filters button
        document
          .getElementById("applyFilters")
          .addEventListener("click", applyFilters);
      }

      // Load available countries for filter
      async function loadCountryOptions() {
        try {
          const response = await fetch(`${ADMIN_API_URL}/countries`);

          if (!response.ok) return;

          const result = await response.json();
          const select = document.getElementById("countryFilter");

          result.countries.forEach((country) => {
            const option = document.createElement("option");
            option.value = country;
            option.textContent = country;
            select.appendChild(option);
          });
        } catch (error) {
          console.error("Error loading countries:", error);
        }
      }

      // Apply filters and reload data
      function applyFilters() {
        // Get filter values
        const startDate = document.getElementById("startDate").value;
        const endDate = document.getElementById("endDate").value;
        const topN = parseInt(document.getElementById("topN").value);
        const excludeCancelled =
          document.getElementById("excludeCancelled").checked;

        // Get selected countries
        const countrySelect = document.getElementById("countryFilter");
        const selectedCountries = Array.from(countrySelect.selectedOptions)
          .map((option) => option.value)
          .filter((v) => v !== "");

        // Update global filters
        currentFilters = {
          start_date: startDate || null,
          end_date: endDate || null,
          countries: selectedCountries.length > 0 ? selectedCountries : null,
          top_n: topN,
          exclude_cancelled: excludeCancelled,
        };

        // Reload all data
        loadAllData();
      }

      // Load all dashboard data
      function loadAllData() {
        loadKPIs();
        loadMonthlyTrend();
        loadTopCountries();
        loadTopProducts();
      }

      // Fetch and display KPIs
      async function loadKPIs() {
        try {
          const response = await fetch(`${ADMIN_API_URL}/kpis`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(currentFilters),
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.detail || "Failed to load KPIs");
          }

          currentData.kpis = data;

          // Update KPI cards
          document.getElementById("totalRevenue").textContent =
            "$" + (data.total_revenue / 1000000).toFixed(2) + "M";
          document.getElementById("totalTransactions").textContent =
            data.total_transactions.toLocaleString();
          document.getElementById("activeCountries").textContent =
            data.countries_active;

          // Show warning if concentration is high
          const shareElement = document.getElementById("topNShare");
          shareElement.textContent = data.top_n_revenue_share.toFixed(1) + "%";
          if (data.top_n_revenue_share > 60) {
            shareElement.style.color = "#e53e3e";
            shareElement.title = "‚ö†Ô∏è High concentration risk!";
          }
        } catch (error) {
          console.error("Error loading KPIs:", error);
          document.getElementById("totalRevenue").textContent = "Error";
        }
      }

      // Fetch and display monthly trend
      async function loadMonthlyTrend() {
        try {
          const response = await fetch(`${ADMIN_API_URL}/monthly-trend`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(currentFilters),
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.detail || "Failed to load monthly trend");
          }

          const data = result.data;
          currentData.monthlyTrend = data;

          // Destroy existing chart if any
          const existingChart = Chart.getChart("monthlyTrendChart");
          if (existingChart) {
            existingChart.destroy();
          }

          // Prepare chart data
          const labels = data.map((d) => d.year_month);
          const revenues = data.map((d) => d.revenue);

          // Find highest and lowest points
          const maxRevenue = Math.max(...revenues);
          const minRevenue = Math.min(...revenues);

          // Create chart
          const ctx = document
            .getElementById("monthlyTrendChart")
            .getContext("2d");
          new Chart(ctx, {
            type: "line",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "Revenue",
                  data: revenues,
                  borderColor: "#667eea",
                  backgroundColor: "rgba(102, 126, 234, 0.1)",
                  borderWidth: 3,
                  fill: true,
                  tension: 0.4,
                  pointRadius: 5,
                  pointHoverRadius: 8,
                  pointBackgroundColor: revenues.map((r) => {
                    if (r === maxRevenue) return "#38a169";
                    if (r === minRevenue) return "#e53e3e";
                    return "#667eea";
                  }),
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  display: true,
                  position: "top",
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      const index = context.dataIndex;
                      const momGrowth = data[index].mom_growth;
                      let label =
                        "Revenue: $" + context.parsed.y.toLocaleString();
                      if (momGrowth !== null) {
                        label += "\nMoM: " + momGrowth.toFixed(1) + "%";
                      }
                      return label;
                    },
                  },
                },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function (value) {
                      return "$" + (value / 1000).toFixed(0) + "K";
                    },
                  },
                },
              },
            },
          });

          // Generate recommendations after data loads
          generateRecommendations();
        } catch (error) {
          console.error("Error loading monthly trend:", error);
          document.getElementById("monthlyTrendContainer").innerHTML =
            '<div class="error">Failed to load monthly trend data</div>';
        }
      }

      // Fetch and display top countries
      async function loadTopCountries() {
        try {
          const response = await fetch(`${ADMIN_API_URL}/top-countries`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(currentFilters),
          });

          if (!response.ok) throw new Error("Failed to load top countries");

          const result = await response.json();
          const data = result.data;
          currentData.topCountries = data;

          // Create bar chart
          createCountriesBarChart(data);

          // Build table HTML with drill-down
          const tbody = document.querySelector("#topCountriesTable tbody");
          tbody.innerHTML = data
            .map(
              (country) => `
                    <tr class="clickable-row" onclick="drillDownCountry('${country.item}')">
                        <td>${country.rank}</td>
                        <td><strong>${country.item}</strong></td>
                        <td>$${country.revenue.toLocaleString()}</td>
                        <td>${country.share_pct.toFixed(2)}%</td>
                        <td>${country.transactions.toLocaleString()}</td>
                    </tr>
                `
            )
            .join("");
        } catch (error) {
          console.error("Error loading top countries:", error);
          document.querySelector("#topCountriesTable tbody").innerHTML =
            '<tr><td colspan="5" class="error">Failed to load data</td></tr>';
        }
      }

      // Create bar chart for countries
      function createCountriesBarChart(data) {
        const ctx = document
          .getElementById("topCountriesChart")
          .getContext("2d");

        // Destroy existing chart
        const existingChart = Chart.getChart("topCountriesChart");
        if (existingChart) {
          existingChart.destroy();
        }

        new Chart(ctx, {
          type: "bar",
          data: {
            labels: data.map((d) => d.item),
            datasets: [
              {
                label: "Revenue",
                data: data.map((d) => d.revenue),
                backgroundColor: data.map((d, i) => {
                  const opacity = 1 - i * 0.05;
                  return `rgba(102, 126, 234, ${opacity})`;
                }),
                borderColor: "#667eea",
                borderWidth: 2,
              },
            ],
          },
          options: {
            indexAxis: "y",
            responsive: true,
            maintainAspectRatio: false,
            onClick: (event, elements) => {
              if (elements.length > 0) {
                const index = elements[0].index;
                const country = data[index].item;
                drillDownCountry(country);
              }
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const item = data[context.dataIndex];
                    return [
                      `Revenue: $${item.revenue.toLocaleString()}`,
                      `Share: ${item.share_pct.toFixed(2)}%`,
                      `Transactions: ${item.transactions.toLocaleString()}`,
                    ];
                  },
                },
              },
            },
            scales: {
              x: {
                beginAtZero: true,
                ticks: {
                  callback: function (value) {
                    return "$" + (value / 1000).toFixed(0) + "K";
                  },
                },
              },
            },
          },
        });
      }

      // Drill-down to specific country
      function drillDownCountry(country) {
        if (confirm(`Filter dashboard to show only data for ${country}?`)) {
          const countrySelect = document.getElementById("countryFilter");
          // Clear all selections
          Array.from(countrySelect.options).forEach(
            (opt) => (opt.selected = false)
          );
          // Select the clicked country
          Array.from(countrySelect.options).forEach((opt) => {
            if (opt.value === country) opt.selected = true;
          });
          // Apply filters
          applyFilters();
        }
      }

      // Fetch and display top products
      async function loadTopProducts() {
        try {
          const response = await fetch(`${ADMIN_API_URL}/top-products`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(currentFilters),
          });

          if (!response.ok) throw new Error("Failed to load top products");

          const result = await response.json();
          const data = result.data;
          currentData.topProducts = data;

          // Create bar chart
          createProductsBarChart(data);

          // Build table HTML with drill-down
          const tbody = document.querySelector("#topProductsTable tbody");
          tbody.innerHTML = data
            .map(
              (product) => `
                    <tr class="clickable-row" onclick="showProductTrend('${product.item.split(" - ")[0]}', '${product.item.replace(/'/g, "\\'")}')">
                        <td>${product.rank}</td>
                        <td><strong>${product.item}</strong></td>
                        <td>$${product.revenue.toLocaleString()}</td>
                        <td>${product.share_pct.toFixed(2)}%</td>
                        <td>${product.transactions.toLocaleString()}</td>
                    </tr>
                `
            )
            .join("");
        } catch (error) {
          console.error("Error loading top products:", error);
          document.querySelector("#topProductsTable tbody").innerHTML =
            '<tr><td colspan="5" class="error">Failed to load data</td></tr>';
        }
      }

      // Create bar chart for products
      function createProductsBarChart(data) {
        const ctx = document
          .getElementById("topProductsChart")
          .getContext("2d");

        // Destroy existing chart
        const existingChart = Chart.getChart("topProductsChart");
        if (existingChart) {
          existingChart.destroy();
        }

        new Chart(ctx, {
          type: "bar",
          data: {
            labels: data.map((d) =>
              d.item.length > 40 ? d.item.substring(0, 37) + "..." : d.item
            ),
            datasets: [
              {
                label: "Revenue",
                data: data.map((d) => d.revenue),
                backgroundColor: data.map((d, i) => {
                  const opacity = 1 - i * 0.05;
                  return `rgba(118, 75, 162, ${opacity})`;
                }),
                borderColor: "#764ba2",
                borderWidth: 2,
              },
            ],
          },
          options: {
            indexAxis: "y",
            responsive: true,
            maintainAspectRatio: false,
            onClick: (event, elements) => {
              if (elements.length > 0) {
                const index = elements[0].index;
                const product = data[index];
                showProductTrend(product.item.split(" - ")[0], product.item);
              }
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const item = data[context.dataIndex];
                    return [
                      `Revenue: $${item.revenue.toLocaleString()}`,
                      `Share: ${item.share_pct.toFixed(2)}%`,
                      `Transactions: ${item.transactions.toLocaleString()}`,
                    ];
                  },
                },
              },
            },
            scales: {
              x: {
                beginAtZero: true,
                ticks: {
                  callback: function (value) {
                    return "$" + (value / 1000).toFixed(0) + "K";
                  },
                },
              },
            },
          },
        });
      }

      // Show product trend modal
      async function showProductTrend(stockCode, productName) {
        // Show modal
        document.getElementById("skuTrendModal").style.display = "block";
        document.getElementById("modalProductTitle").textContent =
          `Trend: ${productName}`;

        // For now, we'll use the monthly trend data filtered by this product
        // In a real implementation, you'd call a specific API endpoint
        if (currentData.monthlyTrend) {
          createProductTrendChart(currentData.monthlyTrend, productName);
        }
      }

      // Create trend chart in modal
      function createProductTrendChart(data, productName) {
        const ctx = document.getElementById("modalTrendChart").getContext("2d");

        // Destroy existing chart
        const existingChart = Chart.getChart("modalTrendChart");
        if (existingChart) {
          existingChart.destroy();
        }

        // Use overall monthly trend as proxy (in real app, filter by product)
        new Chart(ctx, {
          type: "line",
          data: {
            labels: data.map((d) => d.year_month),
            datasets: [
              {
                label: "Revenue Trend",
                data: data.map((d) => d.revenue),
                borderColor: "#764ba2",
                backgroundColor: "rgba(118, 75, 162, 0.1)",
                borderWidth: 3,
                fill: true,
                tension: 0.4,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: true },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    return "Revenue: $" + context.parsed.y.toLocaleString();
                  },
                },
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function (value) {
                    return "$" + (value / 1000).toFixed(0) + "K";
                  },
                },
              },
            },
          },
        });
      }

      // Close modal
      function closeModal() {
        document.getElementById("skuTrendModal").style.display = "none";
      }

      // Close modal when clicking outside
      window.onclick = function (event) {
        const modal = document.getElementById("skuTrendModal");
        if (event.target == modal) {
          modal.style.display = "none";
        }
      };

      // Generate action recommendations based on data
      function generateRecommendations() {
        if (
          !currentData.topCountries ||
          !currentData.topProducts ||
          !currentData.monthlyTrend
        ) {
          return;
        }

        const recommendations = [];

        // 1. High concentration warning
        if (currentData.kpis && currentData.kpis.top_n_revenue_share > 60) {
          recommendations.push({
            category: "Risk",
            item: "Revenue Concentration",
            reason: `Top ${currentFilters.top_n} items contribute ${currentData.kpis.top_n_revenue_share.toFixed(1)}% of total revenue`,
            action: "Diversify revenue sources to reduce dependency risk",
            priority: "High",
          });
        }

        // 2. Top country recommendations
        if (currentData.topCountries.length > 0) {
          const topCountry = currentData.topCountries[0];
          recommendations.push({
            category: "Country",
            item: topCountry.item,
            reason: `Highest revenue contributor (${topCountry.share_pct.toFixed(1)}%)`,
            action: `Increase marketing budget for ${topCountry.item} market`,
            priority: "High",
          });

          // Emerging markets (low rank but decent share)
          if (currentData.topCountries.length >= 5) {
            const emerging = currentData.topCountries[4];
            if (emerging.share_pct > 3) {
              recommendations.push({
                category: "Country",
                item: emerging.item,
                reason: `Emerging market with ${emerging.share_pct.toFixed(1)}% share`,
                action: `Test expansion campaigns in ${emerging.item}`,
                priority: "Medium",
              });
            }
          }
        }

        // 3. Top product recommendations
        if (currentData.topProducts.length >= 2) {
          const topProduct = currentData.topProducts[0];
          const secondProduct = currentData.topProducts[1];

          recommendations.push({
            category: "Product",
            item: topProduct.item.split(" - ")[0],
            reason: `Best seller with ${topProduct.share_pct.toFixed(1)}% revenue share`,
            action: `Create bundle with #${secondProduct.rank} product for cross-selling`,
            priority: "Medium",
          });
        }

        // 4. Monthly trend analysis
        if (currentData.monthlyTrend.length >= 3) {
          const recentMonths = currentData.monthlyTrend.slice(-3);
          const avgGrowth =
            recentMonths
              .filter((m) => m.mom_growth !== null)
              .reduce((sum, m) => sum + m.mom_growth, 0) / recentMonths.length;

          if (avgGrowth < -5) {
            recommendations.push({
              category: "Trend",
              item: "Revenue Decline",
              reason: `Average MoM growth: ${avgGrowth.toFixed(1)}% (last 3 months)`,
              action: "Launch promotional campaign to boost sales",
              priority: "High",
            });
          } else if (avgGrowth > 10) {
            recommendations.push({
              category: "Trend",
              item: "Growth Momentum",
              reason: `Strong growth trend: ${avgGrowth.toFixed(1)}% MoM`,
              action: "Increase inventory and prepare for scaling",
              priority: "Medium",
            });
          }
        }

        // 5. Low performers to optimize
        if (currentData.topProducts.length >= currentFilters.top_n) {
          const lowPerformer =
            currentData.topProducts[currentFilters.top_n - 1];
          if (lowPerformer.share_pct < 2) {
            recommendations.push({
              category: "Product",
              item: lowPerformer.item.split(" - ")[0],
              reason: `Low revenue share (${lowPerformer.share_pct.toFixed(2)}%)`,
              action:
                "Consider A/B testing price optimization or discontinuation",
              priority: "Low",
            });
          }
        }

        // Display recommendations
        const tbody = document.querySelector("#recommendationsTable tbody");
        if (recommendations.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="5">No specific recommendations at this time.</td></tr>';
        } else {
          tbody.innerHTML = recommendations
            .map(
              (rec) => `
                    <tr>
                        <td><strong>${rec.category}</strong></td>
                        <td>${rec.item}</td>
                        <td>${rec.reason}</td>
                        <td>${rec.action}</td>
                        <td class="priority-${rec.priority.toLowerCase()}">${rec.priority}</td>
                    </tr>
                `
            )
            .join("");
        }
      }

      // Export table to CSV
      function exportTable(tableId, filename) {
        const table = document.getElementById(tableId);
        const rows = Array.from(table.querySelectorAll("tr"));

        const csv = rows
          .map((row) => {
            const cols = Array.from(row.querySelectorAll("th, td"));
            return cols
              .map((col) => {
                let text = col.textContent.trim();
                // Escape quotes and wrap in quotes if contains comma
                if (text.includes(",") || text.includes('"')) {
                  text = '"' + text.replace(/"/g, '""') + '"';
                }
                return text;
              })
              .join(",");
          })
          .join("\n");

        // Download
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `${filename}_${new Date().toISOString().split("T")[0]}.csv`;
        link.click();
      }

      // Save insights snapshot
      function saveInsights() {
        const snapshot = {
          timestamp: new Date().toISOString(),
          filters: currentFilters,
          kpis: currentData.kpis,
          recommendations: Array.from(
            document.querySelectorAll("#recommendationsTable tbody tr")
          )
            .map((row) => {
              const cols = Array.from(row.querySelectorAll("td"));
              if (cols.length < 5) return null;
              return {
                category: cols[0].textContent.trim(),
                item: cols[1].textContent.trim(),
                reason: cols[2].textContent.trim(),
                action: cols[3].textContent.trim(),
                priority: cols[4].textContent.trim(),
              };
            })
            .filter((r) => r !== null),
        };

        // Save to localStorage
        const savedInsights = JSON.parse(
          localStorage.getItem("adminInsights") || "[]"
        );
        savedInsights.push(snapshot);
        localStorage.setItem("adminInsights", JSON.stringify(savedInsights));

        // Also download as JSON
        const blob = new Blob([JSON.stringify(snapshot, null, 2)], {
          type: "application/json",
        });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `Insights_${new Date().toISOString().split("T")[0]}.json`;
        link.click();

        alert("‚úÖ Insights saved successfully!");
      }
    </script>
  </body>
</html>
